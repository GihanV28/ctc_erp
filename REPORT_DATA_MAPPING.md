# Report Data Mapping Documentation

This document explains where each report type gets its data from in the Ceylon Cargo Transport system.

## Report Types and Data Sources

### 1. Shipment Report (`shipment`)

**Data Source**: `Shipment` collection

**Fields Mapped**:
- `shipmentId` → Auto-generated ID (SHP-001, SHP-002, etc.)
- `trackingNumber` → Tracking number from shipment
- `client` → Populated from `Client` collection (companyName)
- `supplier` → Populated from `Supplier` collection (companyName)
- `status` → Shipment status (booked, in_transit, customs, delivered)
- `origin` → Route origin (port, country)
- `destination` → Route destination (port, country)
- `cost` → Total cost from shipment
- `currency` → Currency used
- `bookingDate` → Booking date
- `estimatedArrival` → Estimated arrival date

**Filters Available**:
- Status filter (booked, in_transit, customs, delivered)
- Client filter (specific client ID)

**Generated By**: [reportGenerator.js:75-113](apps/api/src/utils/reportGenerator.js#L75-L113)

---

### 2. Financial Report (`financial`)

**Data Sources**:
- `Income` collection
- `Expense` collection

**Metrics Calculated**:
- Total Income: Sum of all income amounts in date range
- Total Expenses: Sum of all expense amounts in date range
- Net Profit: Total Income - Total Expenses

**Data Structure**:
```javascript
[
  { category: 'Total Income', amount: X, count: Y },
  { category: 'Total Expenses', amount: X, count: Y },
  { category: 'Net Profit', amount: X, count: '-' },
  { category: '--- Income Breakdown ---', ... },
  // Individual income records
  { category: '--- Expense Breakdown ---', ... },
  // Individual expense records
]
```

**Generated By**: [reportGenerator.js:116-179](apps/api/src/utils/reportGenerator.js#L116-L179)

---

### 3. Client Performance Report (`client_performance`)

**Data Source**: `Shipment` collection (grouped by client)

**Metrics Per Client**:
- `clientName` → From populated client data
- `clientId` → Client ID (CLT-001, etc.)
- `shipmentCount` → Total shipments for this client
- `totalRevenue` → Sum of totalCost for all shipments
- `onTimeDeliveries` → Count where actualArrival <= estimatedArrival
- `totalDeliveries` → Count of delivered shipments
- `onTimeRate` → (onTimeDeliveries / totalDeliveries) * 100

**Filters Available**:
- Client filter (specific client ID)

**On-Time Calculation**:
```javascript
if (shipment.status === 'delivered' &&
    shipment.dates.actualArrival <= shipment.dates.estimatedArrival) {
  // Counted as on-time
}
```

**Generated By**: [reportGenerator.js:182-243](apps/api/src/utils/reportGenerator.js#L182-L243)

---

### 4. Container Utilization Report (`container_utilization`)

**Data Source**: `Container` collection

**Fields Mapped**:
- `containerId` → Container ID (CONT-001, etc.)
- `type` → Container type (20ft_standard, 40ft_high_cube, etc.)
- `size` → Container size
- `status` → Status (available, in_use, maintenance)
- `condition` → Condition (excellent, good, fair, poor)
- `location` → Current location
- `lastInspection` → Last inspection date

**Metrics Calculated**:
- Total containers
- Containers in use
- Utilization Rate: (inUse / total) * 100

**Filters Available**:
- Container type filter
- Status filter

**Generated By**: [reportGenerator.js:246-278](apps/api/src/utils/reportGenerator.js#L246-L278)

---

### 5. Performance Analytics Report (`performance_analytics`)

**Data Sources**:
- `Shipment` collection
- `Income` collection
- `Expense` collection

**KPIs Calculated**:

1. **Total Shipments**
   - Count of all shipments in date range

2. **Total Revenue**
   - Sum of all income amounts

3. **Total Costs**
   - Sum of all expense amounts

4. **Net Profit**
   - Total Revenue - Total Costs

5. **Profit Margin**
   - (Net Profit / Total Revenue) * 100

6. **On-Time Delivery Rate**
   - (Delivered on time / Total delivered) * 100
   - On-time = actualArrival <= estimatedArrival

7. **Delivered Shipments**
   - Count where status = 'delivered'

8. **In-Transit Shipments**
   - Count where status = 'in_transit'

**Data Structure**:
```javascript
[
  { metric: 'Total Shipments', value: X },
  { metric: 'Total Revenue', value: '$X.XX' },
  { metric: 'Total Costs', value: '$X.XX' },
  { metric: 'Net Profit', value: '$X.XX' },
  { metric: 'Profit Margin', value: 'X%' },
  { metric: 'On-Time Delivery Rate', value: 'X%' },
  { metric: 'Delivered Shipments', value: X },
  { metric: 'In-Transit Shipments', value: X }
]
```

**Generated By**: [reportGenerator.js:281-328](apps/api/src/utils/reportGenerator.js#L281-L328)

---

### 6. Supplier Performance Report (`supplier_performance`)

**Data Source**: `Shipment` collection (grouped by supplier)

**Metrics Per Supplier**:
- `supplierName` → From populated supplier data
- `supplierId` → Supplier ID (SUP-001, etc.)
- `shipmentCount` → Total shipments handled by this supplier
- `onTimeDeliveries` → Count where actualArrival <= estimatedArrival
- `totalDeliveries` → Count of delivered shipments
- `onTimeRate` → (onTimeDeliveries / totalDeliveries) * 100

**Filters Available**:
- Supplier filter (specific supplier ID)

**On-Time Calculation**:
Same as Client Performance - checks if actualArrival <= estimatedArrival for delivered shipments.

**Generated By**: [reportGenerator.js:331-388](apps/api/src/utils/reportGenerator.js#L331-L388)

---

## Database Collections Overview

### Shipment Collection Schema
```javascript
{
  shipmentId: String,          // Auto: SHP-001
  trackingNumber: String,      // Auto-generated
  client: ObjectId,            // ref: Client
  supplier: ObjectId,          // ref: Supplier
  route: {
    origin: { port, city, country },
    destination: { port, city, country }
  },
  status: String,              // booked, in_transit, customs, delivered
  cargo: {
    description: String,
    weight: Number,
    volume: Number,
    quantity: Number,
    containerType: String
  },
  dates: {
    bookingDate: Date,
    departureDate: Date,
    estimatedArrival: Date,
    actualArrival: Date        // Only set when delivered
  },
  totalCost: Number,
  currency: String,
  createdAt: Date
}
```

### Income Collection Schema
```javascript
{
  source: String,              // freight_charges, handling_fees, etc.
  description: String,
  amount: Number,
  currency: String,
  date: Date,
  paymentMethod: String,
  status: String,              // received, pending
  amountReceived: Number,
  createdBy: ObjectId,
  createdAt: Date
}
```

### Expense Collection Schema
```javascript
{
  category: String,            // fuel, port_fees, staff_salaries, etc.
  description: String,
  amount: Number,
  currency: String,
  date: Date,
  paymentMethod: String,
  status: String,              // paid, pending
  createdBy: ObjectId,
  createdAt: Date
}
```

### Container Collection Schema
```javascript
{
  containerId: String,         // Auto: CONT-001
  containerNumber: String,     // CCTU0001234
  type: String,                // 20ft_standard, 40ft_high_cube, etc.
  status: String,              // available, in_use, maintenance
  condition: String,           // excellent, good, fair, poor
  location: String,
  currentShipment: ObjectId,   // ref: Shipment (if in_use)
  lastInspectionDate: Date,
  createdAt: Date
}
```

---

## Sample Data Distribution (Enhanced Seed)

### Shipments
- **Total**: 45 shipments
- **2025 (Q3-Q4)**: 25 shipments
- **2026 (Q1)**: 20 shipments

### Distribution by Status
- **Delivered**: ~28 shipments (with actualArrival dates)
- **In Transit**: ~12 shipments
- **Booked**: ~5 shipments

### On-Time Performance
- **80%** of delivered shipments are on-time (actualArrival <= estimatedArrival)
- **20%** are delayed (actualArrival > estimatedArrival)

### Financial Data
- **Income Records**: ~45 (one per shipment for freight charges)
- **Expense Records**: ~110+
  - Port fees and fuel costs per shipment
  - Monthly staff salaries (7 months)
  - Monthly utilities (7 months)

### Containers
- **Total**: 20 containers
- **Available**: 15 containers
- **In Use**: 5 containers (linked to in-transit shipments)

### Clients
- **Total**: 5 active clients
- All have multiple shipments for performance tracking

### Suppliers
- **Total**: 3 active suppliers
- All have multiple shipments for performance tracking

---

## Running the Enhanced Seed

```bash
cd apps/api
node scripts/seed-enhanced.js
```

This will populate the database with comprehensive, realistic data across 2025-2026, ensuring all reports have meaningful data to display.

---

## Report Generation Flow

1. **User selects date range** → Frontend caches in localStorage
2. **User clicks "Configure & Generate"** → Opens ConfigureReportModal
3. **User selects format** (PDF/Excel/CSV) and options
4. **Frontend calls** `POST /api/reports/generate`
5. **Backend**:
   - Queries appropriate collection(s) based on report type
   - Filters by date range and additional filters
   - Calculates metrics
   - Generates file (PDF/Excel/CSV) with letterhead
   - Saves Report record to database
   - Returns report metadata
6. **Frontend refreshes** Recent Reports table
7. **User can download/email/print** completed reports

---

## Date Range Filtering

All reports use `createdAt` field for date filtering:

- **Shipments**: `createdAt` (booking date)
- **Income**: `date` field
- **Expense**: `date` field
- **Containers**: Not date-filtered (shows current state)

Example query:
```javascript
{
  createdAt: {
    $gte: dateRange.startDate,
    $lte: dateRange.endDate
  }
}
```

---

## Testing Reports

Recommended date ranges for testing with enhanced seed data:

1. **All of 2025**: `2025-07-01` to `2025-12-31`
   - Shows 25 shipments with complete lifecycle
   - Full financial data including delivered shipments

2. **All of 2026 Q1**: `2026-01-01` to `2026-01-31`
   - Shows 20 shipments (mix of statuses)
   - Current month financial data

3. **Last 6 months**: Calculate from today backwards
   - Mix of 2025 and 2026 data
   - Realistic current reporting scenario

4. **Full Date Range**: `2025-01-01` to `2026-12-31`
   - All data across both years
   - Maximum dataset for testing

---

## Troubleshooting

### No data in reports?
- Check date range matches seed data (2025 Q3/Q4 and 2026 Q1)
- Verify seed script ran successfully
- Check MongoDB connection

### Incorrect calculations?
- Verify `actualArrival` dates are set for delivered shipments
- Check currency consistency (all USD in seed data)
- Ensure income/expense records match shipment dates

### Missing client/supplier names?
- Ensure `.populate()` is called in data fetchers
- Check client/supplier IDs are valid ObjectIds
- Verify relationships in seed data

---

**Last Updated**: January 2026
**Seed Script**: `apps/api/scripts/seed-enhanced.js`
**Report Generator**: `apps/api/src/utils/reportGenerator.js`
